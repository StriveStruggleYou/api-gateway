{{define "escape"}}{{.| regexReplaceAll "[^a-zA-Z0-9]" "_"}}{{end}}
{{range $service := services}}
{{range $tag := $service.Tags}}

{{ if $service.Name }}{{if $tag}}
{{ with $serviceQuery := printf "%s.%s" $tag $service.Name }}
{{ if service $serviceQuery }}
upstream {{template "escape" $serviceQuery}} {
    {{range service $serviceQuery}}
        server {{.Address}}:{{.Port}};{{end}}
}
{{end}}{{end}}{{end}}{{end}}{{end}}{{end}}

### Upstream services configured from Consul K/V
{{range $item := tree "auto_discovery/services"}}
{{ if $item.Key | regexMatch ".*/.*" }}{{else}}{{ if $item.Key | regexMatch ".+"}}
{{ if $item.Value | regexMatch ".*@.*"}}
{{/* serviceQuery needs to be sanitized as much as possible because otherwise it has the possibility of breaking consul */}}
{{ with $serviceQuery := regexReplaceAll "[^a-zA-Z0-9@:._-]" "_" $item.Value }}
# query: {{$serviceQuery}}
upstream {{template "escape" $item.Key }}_{{template "escape" $serviceQuery}} {
    {{range service $serviceQuery}}
        server {{.Address}}:{{.Port}};{{end}}
}
{{end}}{{end}}{{end}}{{end}}{{end}}
