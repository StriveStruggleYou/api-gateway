{{define "escape"}}{{.| regexReplaceAll "[^a-zA-Z0-9]" "_"}}{{end}}
{{$env := env "WIKIA_ENVIRONMENT"}}{{$gatewayTree := printf "registry/%s/api-gateway" $env}}
{{range $item := tree $gatewayTree }}
{{ with $serviceQuery := regexReplaceAll "[^a-zA-Z0-9@:._-]" "_" $item.Value }}
# query: {{$serviceQuery}}
{{ with $queryResult := service $serviceQuery }}{{ if $queryResult }}
upstream {{ $item.Key | regexReplaceAll "[^a-zA-Z0-9-_.]" "_" }} {
    {{ range $queryResult }} server {{.Address}}:{{.Port}};{{end}}
}
{{end}}{{end}}
{{end}}{{end}}
